events {
  worker_connections 1024;
}

http {
  # =================================================================
  # CONFIGURACIÓN DE RATE LIMITING Y THROTTLING (ADAPTADO PARA CLOUD)
  # =================================================================
  
  # Zona para rate limiting general (20 req/seg por IP)
  limit_req_zone $binary_remote_addr zone=general:10m rate=20r/s;
  
  # Zona para API Gateway (alta capacidad para cloud)
  limit_req_zone $binary_remote_addr zone=api:10m rate=100r/s;

  # =================================================================
  # CONFIGURACIÓN DE LOGS PARA CLOUD RUN
  # =================================================================
  
  # Formato de log para Cloud Run (JSON compatible)
  log_format cloud_log '{'
                      '"timestamp":"$time_iso8601",'
                      '"remote_addr":"$remote_addr",'
                      '"method":"$request_method",'
                      '"uri":"$request_uri",'
                      '"status":$status,'
                      '"response_time":"$upstream_response_time",'
                      '"user_agent":"$http_user_agent",'
                      '"rate_limit_status":"$limit_req_status"'
                      '}';
  
  # Logs para Cloud Run (stdout/stderr)
  access_log /dev/stdout cloud_log;
  error_log /dev/stderr warn;

  # =================================================================
  # CONFIGURACIÓN PARA CLOUD RUN (SIN UPSTREAM)
  # =================================================================
  
  # Resolver DNS de Google para Cloud Run
  resolver 8.8.8.8 8.8.4.4 valid=300s;
  resolver_timeout 5s;

  # =================================================================
  # SERVIDOR PRINCIPAL - PUERTO 8080 PARA CLOUD RUN
  # =================================================================
  
  server {
    listen 8080;
    server_name _;  # Acepta cualquier host en Cloud Run
    
    # Headers de Cloud Run y seguridad
    add_header X-Served-By "CourseClash-Cloud-Proxy" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;

    # =============================================================
    # API GATEWAY (DESCOMENTA CUANDO TENGAS LA URL)
    # =============================================================
    # location /api {
    #   # Rate limiting para API
    #   limit_req zone=api burst=50 delay=25;
    #   limit_req_status 429;
    #   
    #   # Headers para Cloud Run
    #   add_header X-API-Security "Cloud-Run-TLS" always;
    #   
    #   proxy_pass https://tu-api-gateway-url.us-central1.run.app;
    #   proxy_http_version 1.1;
    #   proxy_set_header Host tu-api-gateway-url.us-central1.run.app;
    #   proxy_set_header X-Real-IP $remote_addr;
    #   proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #   proxy_set_header X-Forwarded-Proto https;
    #   
    #   # SSL configuration
    #   proxy_ssl_verify off;  # Temporal para debug
    #   proxy_ssl_server_name on;
    #   
    #   # Timeouts
    #   proxy_connect_timeout 10s;
    #   proxy_send_timeout 60s;
    #   proxy_read_timeout 60s;
    # }

    # =============================================================
    # WEBSOCKETS (TEMPORAL - REDIRECCIÓN A FRONTEND)
    # =============================================================
    location /ws/ {
      # Rate limiting para WebSocket
      limit_req zone=general burst=10 delay=6;
      limit_req_status 429;
      
      # Proxy directo a Cloud Run (sin upstream)
      proxy_pass https://courseclash-frontend-433766410684.us-central1.run.app/ws/;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header Host courseclash-frontend-433766410684.us-central1.run.app;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;
      
      # SSL configuration - deshabilitado temporalmente para debug
      proxy_ssl_verify off;
      proxy_ssl_server_name on;
      
      proxy_connect_timeout 10s;
      proxy_send_timeout 3600s;
      proxy_read_timeout 3600s;
    }

    # =============================================================
    # FRONTEND PRINCIPAL
    # =============================================================
    location / {
      # Rate limiting para frontend
      limit_req zone=general burst=16 delay=12;
      limit_req_status 429;
      
      # Headers específicos para Cloud Run
      add_header X-Cloud-Service "courseclash-frontend" always;
      
      # Proxy directo a Cloud Run (sin upstream)
      proxy_pass https://courseclash-frontend-433766410684.us-central1.run.app/;
      proxy_http_version 1.1;
      proxy_set_header Host courseclash-frontend-433766410684.us-central1.run.app;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto https;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      
      # SSL configuration - deshabilitado temporalmente para debug
      proxy_ssl_verify off;
      proxy_ssl_server_name on;
      
      # Cache para contenido estático
      proxy_cache_valid 200 302 10m;
      proxy_cache_valid 404 1m;
      
      # Timeouts
      proxy_connect_timeout 10s;
      proxy_send_timeout 60s;
      proxy_read_timeout 60s;
    }

    # =============================================================
    # HEALTH CHECK PARA CLOUD RUN
    # =============================================================
    location /health {
      add_header Content-Type application/json always;
      add_header X-Health-Check "cloud-run" always;
      return 200 '{"status":"healthy","platform":"cloud-run","rate_limiting":"active","timestamp":"$time_iso8601"}';
    }
  }
} 